name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Pin Swift 6.2 across all jobs to match local dev (macOS 15 ships Swift 6.0
# which has stricter/different concurrency rules than 6.2).
env:
  SWIFT_VERSION: "6.2"

jobs:
  build-and-test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Build
        run: swift build

      - name: Run tests
        run: swift run MarkViewTestRunner

      - name: Verify
        run: bash verify.sh

  fuzz-test:
    runs-on: macos-15
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Build fuzz tester
        run: swift build

      - name: Run fuzz tests (10,000 inputs)
        run: swift run MarkViewFuzzTester
        timeout-minutes: 10

  diff-test:
    runs-on: macos-15
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Build diff tester
        run: swift build

      - name: Run differential tests
        run: swift run MarkViewDiffTester

  visual-test:
    runs-on: macos-15
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Generate visual goldens
        run: swift run MarkViewVisualTester --generate-goldens

      - name: Run visual regression tests
        run: swift run MarkViewVisualTester

  golden-check:
    runs-on: macos-15
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Regenerate goldens
        run: swift run MarkViewTestRunner --generate-goldens

      - name: Check for golden drift
        run: git diff --exit-code Tests/TestRunner/Fixtures/expected/
